# Fish Speech TTS API ì„œë²„ë¥¼ ìœ„í•œ GPU ë²„ì „ Dockerfile (ìˆ˜ì •ëœ ë²„ì „)
FROM pytorch/pytorch:2.4.0-cuda12.1-cudnn9-devel

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì˜¤ë””ì˜¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
RUN apt-get update && apt-get install -y \
    git \
    wget \
    build-essential \
    libsndfile1 \
    libsndfile1-dev \
    ffmpeg \
    portaudio19-dev \
    libasound2-dev \
    libportaudio2 \
    libpulse-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Fish Speech ì €ì¥ì†Œ í´ë¡ 
RUN git clone https://github.com/fishaudio/fish-speech.git /app/fish-speech

# Fish Speech ë””ë ‰í† ë¦¬ë¡œ ì´ë™
WORKDIR /app/fish-speech

# Python ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --upgrade pip setuptools wheel

# PyTorch GPU ë²„ì „ ì„¤ì¹˜
RUN pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cu121

# í•„ìˆ˜ ì˜ì¡´ì„± ë¨¼ì € ì„¤ì¹˜
RUN pip install pyrootutils>=1.0.4 fastapi uvicorn httpx librosa soundfile numpy

# Fish Speech í•µì‹¬ ì˜ì¡´ì„± ìˆ˜ë™ ì„¤ì¹˜
RUN pip install \
    accelerate \
    datasets \
    einops \
    fire \
    hydra-core \
    lightning \
    omegaconf \
    rich \
    tensorboard \
    transformers>=4.0.0 \
    gradio \
    wandb \
    loguru \
    natsort \
    tensorboardX \
    matplotlib \
    click \
    tqdm

# pyaudio ìˆ˜ë™ ì„¤ì¹˜ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
RUN pip install pyaudio || echo "pyaudio ì„¤ì¹˜ ì‹¤íŒ¨ - ê³„ì† ì§„í–‰"

# Fish Speech ì†ŒìŠ¤ ì„¤ì¹˜
RUN pip install -e . && echo "Fish Speech ì†ŒìŠ¤ ì„¤ì¹˜ ì„±ê³µ" || echo "Fish Speech ì†ŒìŠ¤ ì„¤ì¹˜ ì‹¤íŒ¨"

# ì„¤ì¹˜ ìƒíƒœ í™•ì¸
RUN python -c "import fish_speech; print('Fish Speech ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ')" || echo "Fish Speech ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨"

# ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
RUN find /app/fish-speech -name "*.py" | grep -E "(api|webui)" | head -10 || echo "API ê´€ë ¨ íŒŒì¼ ì°¾ê¸° ì‹¤íŒ¨"

# S1 ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
RUN mkdir -p checkpoints
RUN wget -O checkpoints/fish-speech-1.4-s1.pth \
    https://huggingface.co/fishaudio/fish-speech-1.4/resolve/main/fish-speech-1.4-s1.pth || \
    echo "ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ - ëŸ°íƒ€ì„ì— ìë™ ë‹¤ìš´ë¡œë“œë¨"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8765

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONPATH=/app/fish-speech
ENV CUDA_VISIBLE_DEVICES=0

# Fish Speech API ì„œë²„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •)
RUN echo '#!/bin/bash\n\
cd /app/fish-speech\n\
echo "ğŸŸ Fish Speech API ì„œë²„ ì‹œì‘ ì¤‘..."\n\
\n\
# Fish Speech ì„¤ì¹˜ í™•ì¸\n\
echo "ğŸ“‹ Fish Speech ì„¤ì¹˜ ìƒíƒœ í™•ì¸..."\n\
python -c "import fish_speech; print(\"Fish Speech ë²„ì „:\", getattr(fish_speech, \"__version__\", \"unknown\"))" || echo "âŒ Fish Speech ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨"\n\
\n\
# ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸\n\
echo "ğŸ“ API ê´€ë ¨ íŒŒì¼ ì°¾ê¸°..."\n\
find . -name "*api*" -type f | head -5\n\
find . -name "*webui*" -type d | head -5\n\
\n\
# Python ëª¨ë“ˆ êµ¬ì¡° í™•ì¸\n\
echo "ğŸ“‹ fish_speech ëª¨ë“ˆ êµ¬ì¡°:"\n\
python -c "import fish_speech; import os; print([f for f in os.listdir(\"fish_speech\") if not f.startswith(\"__\")])" || echo "ëª¨ë“ˆ êµ¬ì¡° í™•ì¸ ì‹¤íŒ¨"\n\
\n\
# ì—¬ëŸ¬ API ì‹œì‘ ë°©ë²• ì‹œë„\n\
echo "ğŸš€ API ì„œë²„ ì‹œì‘ ì‹œë„..."\n\
\n\
# ë°©ë²• 1: fish_speech.webui.launch ëª¨ë“ˆ\n\
if python -c "import fish_speech.webui.launch" 2>/dev/null; then\n\
    echo "âœ… webui.launch ëª¨ë“ˆ ë°œê²¬ - ë°©ë²• 1 ì‹œë„"\n\
    python -m fish_speech.webui.launch \\\n\
        --listen 0.0.0.0 \\\n\
        --port 8765 \\\n\
        --inbrowser False \\\n\
        --api\n\
# ë°©ë²• 2: fish_speech.webui.api ëª¨ë“ˆ\n\
elif python -c "import fish_speech.webui.api" 2>/dev/null; then\n\
    echo "âœ… webui.api ëª¨ë“ˆ ë°œê²¬ - ë°©ë²• 2 ì‹œë„"\n\
    python -m fish_speech.webui.api \\\n\
        --listen 0.0.0.0:8765 \\\n\
        --llama-checkpoint-path checkpoints/fish-speech-1.4-s1.pth \\\n\
        --decoder-checkpoint-path checkpoints \\\n\
        --device cuda:0 \\\n\
        --compile \\\n\
        --max-length 4096\n\
# ë°©ë²• 3: tools/webui.py\n\
elif [ -f "tools/webui.py" ]; then\n\
    echo "âœ… tools/webui.py ë°œê²¬ - ë°©ë²• 3 ì‹œë„"\n\
    python tools/webui.py \\\n\
        --listen 0.0.0.0 \\\n\
        --port 8765 \\\n\
        --inbrowser False \\\n\
        --api\n\
# ë°©ë²• 4: tools/api.py\n\
elif [ -f "tools/api.py" ]; then\n\
    echo "âœ… tools/api.py ë°œê²¬ - ë°©ë²• 4 ì‹œë„"\n\
    python tools/api.py \\\n\
        --listen 0.0.0.0:8765 \\\n\
        --llama-checkpoint-path checkpoints/fish-speech-1.4-s1.pth \\\n\
        --decoder-checkpoint-path checkpoints \\\n\
        --device cuda:0\n\
# ë°©ë²• 5: webui.py\n\
elif [ -f "webui.py" ]; then\n\
    echo "âœ… webui.py ë°œê²¬ - ë°©ë²• 5 ì‹œë„"\n\
    python webui.py \\\n\
        --listen 0.0.0.0 \\\n\
        --port 8765 \\\n\
        --inbrowser False \\\n\
        --api\n\
# ë°©ë²• 6: ê°€ëŠ¥í•œ ëª¨ë“  íŒŒì¼ íƒìƒ‰\n\
else\n\
    echo "âŒ í‘œì¤€ API ì‹œì‘ ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"\n\
    echo "ğŸ“‹ ê°€ëŠ¥í•œ ì‹¤í–‰ íŒŒì¼ë“¤:"\n\
    find . -name "*.py" -path "*/webui*" -o -name "*.py" -path "*api*" | head -10\n\
    \n\
    echo "ğŸ”§ fish_speech íŒ¨í‚¤ì§€ì—ì„œ ì§ì ‘ API ëª¨ë“ˆ ì°¾ê¸°..."\n\
    python -c "\n\
import fish_speech\n\
import os\n\
import sys\n\
\n\
# fish_speech íŒ¨í‚¤ì§€ ê²½ë¡œ í™•ì¸\n\
pkg_path = fish_speech.__path__[0]\n\
print(f\"Fish Speech íŒ¨í‚¤ì§€ ê²½ë¡œ: {pkg_path}\")\n\
\n\
# webui ê´€ë ¨ ëª¨ë“ˆ ì°¾ê¸°\n\
webui_path = os.path.join(pkg_path, \"webui\")\n\
if os.path.exists(webui_path):\n\
    print(f\"WebUI ëª¨ë“ˆ ê²½ë¡œ: {webui_path}\")\n\
    print(\"WebUI ëª¨ë“ˆ íŒŒì¼ë“¤:\")\n\
    for f in os.listdir(webui_path):\n\
        if f.endswith(\".py\") and not f.startswith(\"__\"):\n\
            print(f\"  - {f}\")\n\
else:\n\
    print(\"WebUI ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤.\")\n\
\n\
# ê°€ëŠ¥í•œ ì‹¤í–‰ ë°©ë²• ì‹œë„\n\
try:\n\
    import fish_speech.webui\n\
    print(\"âœ… fish_speech.webui ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ\")\n\
    \n\
    # webuiì˜ í•˜ìœ„ ëª¨ë“ˆë“¤ í™•ì¸\n\
    webui_dir = os.path.dirname(fish_speech.webui.__file__)\n\
    for file in os.listdir(webui_dir):\n\
        if file.endswith(\".py\") and not file.startswith(\"__\"):\n\
            module_name = file[:-3]\n\
            try:\n\
                __import__(f\"fish_speech.webui.{module_name}\")\n\
                print(f\"  âœ… fish_speech.webui.{module_name} ë¡œë“œ ì„±ê³µ\")\n\
            except Exception as e:\n\
                print(f\"  âŒ fish_speech.webui.{module_name} ë¡œë“œ ì‹¤íŒ¨: {e}\")\n\
                \n\
except Exception as e:\n\
    print(f\"âŒ fish_speech.webui ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨: {e}\")\n\
"\n\
    \n\
    echo "ğŸ”§ ê°„ë‹¨í•œ Fish Speech API ì„œë²„ ì‹¤í–‰..."\n\
    python -c "\n\
from fastapi import FastAPI, HTTPException\n\
from pydantic import BaseModel\n\
import uvicorn\n\
import sys\n\
import os\n\
\n\
# Fish Speech ëª¨ë“ˆ ê²½ë¡œ ì¶”ê°€\n\
sys.path.insert(0, \"/app/fish-speech\")\n\
\n\
app = FastAPI(title=\"Fish Speech API\", version=\"1.0.0\")\n\
\n\
class TTSRequest(BaseModel):\n\
    text: str\n\
    speaker: str = \"default\"\n\
    format: str = \"wav\"\n\
\n\
@app.get(\"/health\")\n\
def health():\n\
    return {\"status\": \"ok\", \"service\": \"fish-speech\", \"version\": \"1.4\"}\n\
\n\
@app.get(\"/\")\n\
def root():\n\
    return {\n\
        \"message\": \"Fish Speech API Server\", \n\
        \"status\": \"running\",\n\
        \"endpoints\": [\"/health\", \"/tts\", \"/voices\"]\n\
    }\n\
\n\
@app.post(\"/tts\")\n\
def text_to_speech(request: TTSRequest):\n\
    \"\"\"TTS ì—”ë“œí¬ì¸íŠ¸ - í˜„ì¬ëŠ” Mock ì‘ë‹µ\"\"\"\n\
    try:\n\
        # Fish Speech ëª¨ë“ˆ ë¡œë“œ ì‹œë„\n\
        import fish_speech\n\
        return {\n\
            \"status\": \"success\",\n\
            \"message\": \"TTS ìš”ì²­ ì ‘ìˆ˜ë¨ (Fish Speech ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ)\",\n\
            \"text\": request.text,\n\
            \"speaker\": request.speaker,\n\
            \"format\": request.format,\n\
            \"audio_url\": \"/audio/generated/sample.wav\"\n\
        }\n\
    except Exception as e:\n\
        return {\n\
            \"status\": \"error\",\n\
            \"message\": f\"Fish Speech ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨: {str(e)}\",\n\
            \"text\": request.text,\n\
            \"fallback\": True\n\
        }\n\
\n\
@app.get(\"/voices\")\n\
def list_voices():\n\
    \"\"\"ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ëª©ë¡\"\"\"\n\
    return {\n\
        \"voices\": [\n\
            {\"id\": \"default\", \"name\": \"Default\", \"language\": \"ko\"},\n\
            {\"id\": \"female_1\", \"name\": \"Female Voice 1\", \"language\": \"ko\"},\n\
            {\"id\": \"male_1\", \"name\": \"Male Voice 1\", \"language\": \"ko\"}\n\
        ]\n\
    }\n\
\n\
if __name__ == \"__main__\":\n\
    print(\"ğŸš€ Fish Speech API ì„œë²„ ì‹œì‘...\")\n\
    uvicorn.run(app, host=\"0.0.0.0\", port=8765, log_level=\"info\")\n\
"\n\
fi\n\
' > /app/start_server.sh

RUN chmod +x /app/start_server.sh

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=3 \
    CMD curl -f http://localhost:8765/health || curl -f http://localhost:8765/ || exit 1

# ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹
CMD ["/app/start_server.sh"]
