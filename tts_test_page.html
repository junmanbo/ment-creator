<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .audio-controls {
            margin-top: 15px;
        }
        audio {
            width: 100%;
            margin-top: 10px;
        }
        .generation-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }
        .generation-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ TTS ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div class="section" id="loginSection">
            <h3>1. ë¡œê·¸ì¸</h3>
            <label for="username">ì‚¬ìš©ìëª…:</label>
            <input type="text" id="username" value="test_user" placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            
            <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
            <input type="password" id="password" value="test_password123" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            
            <button onclick="login()">ë¡œê·¸ì¸</button>
            <button onclick="register()">ì‚¬ìš©ì ë“±ë¡</button>
            
            <div id="loginStatus"></div>
        </div>
        
        <!-- ì„±ìš° ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="section hidden" id="voiceActorSection">
            <h3>2. ì„±ìš° ê´€ë¦¬</h3>
            
            <div style="margin-bottom: 20px;">
                <h4>ê¸°ì¡´ ì„±ìš° ëª©ë¡</h4>
                <button onclick="loadVoiceActors()">ì„±ìš° ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <select id="voiceActorSelect">
                    <option value="">ì„±ìš°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div>
                <h4>ìƒˆ ì„±ìš° ë“±ë¡</h4>
                <label for="actorName">ì„±ìš°ëª…:</label>
                <input type="text" id="actorName" placeholder="ì„±ìš° ì´ë¦„">
                
                <label for="actorGender">ì„±ë³„:</label>
                <select id="actorGender">
                    <option value="female">ì—¬ì„±</option>
                    <option value="male">ë‚¨ì„±</option>
                    <option value="neutral">ì¤‘ì„±</option>
                </select>
                
                <label for="actorAge">ì—°ë ¹ëŒ€:</label>
                <select id="actorAge">
                    <option value="20s">20ëŒ€</option>
                    <option value="30s">30ëŒ€</option>
                    <option value="40s">40ëŒ€</option>
                    <option value="50s">50ëŒ€</option>
                </select>
                
                <label for="actorDescription">ì„¤ëª…:</label>
                <textarea id="actorDescription" placeholder="ì„±ìš°ì— ëŒ€í•œ ì„¤ëª…"></textarea>
                
                <button onclick="createVoiceActor()">ì„±ìš° ë“±ë¡</button>
            </div>
            
            <div id="voiceActorStatus"></div>
        </div>
        
        <!-- TTS ìƒì„± ì„¹ì…˜ -->
        <div class="section hidden" id="ttsSection">
            <h3>3. TTS ìƒì„±</h3>
            
            <label for="ttsText">ìƒì„±í•  í…ìŠ¤íŠ¸:</label>
            <textarea id="ttsText" placeholder="ìŒì„±ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">ì•ˆë…•í•˜ì„¸ìš”. OOì†í•´ë³´í—˜ì…ë‹ˆë‹¤. ê³ ê°ë‹˜ì˜ ì†Œì¤‘í•œ ì¬ì‚°ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</textarea>
            
            <label for="selectedVoiceActor">ì„±ìš° ì„ íƒ:</label>
            <select id="selectedVoiceActor">
                <option value="">ì„±ìš°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
            
            <button onclick="generateTTS()" id="generateBtn">TTS ìƒì„±í•˜ê¸°</button>
            
            <div id="ttsStatus"></div>
            
            <div id="audioResult" class="hidden">
                <h4>ìƒì„±ëœ ìŒì„±</h4>
                <audio controls id="audioPlayer"></audio>
                <div class="audio-controls">
                    <button onclick="downloadAudio()">ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
        </div>
        
        <!-- TTS íˆìŠ¤í† ë¦¬ ì„¹ì…˜ -->
        <div class="section hidden" id="historySection">
            <h3>4. TTS ìƒì„± íˆìŠ¤í† ë¦¬</h3>
            <button onclick="loadGenerations()">íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨</button>
            <div id="generationList" class="generation-list"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let accessToken = null;
        let currentGenerationId = null;
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // API í˜¸ì¶œ í—¤ë”
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            return headers;
        }
        
        // ì‚¬ìš©ì ë“±ë¡
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        username,
                        password,
                        email: `${username}@example.com`,
                        full_name: username
                    })
                });
                
                if (response.ok) {
                    showStatus('loginStatus', 'ì‚¬ìš©ì ë“±ë¡ ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'success');
                } else {
                    const error = await response.json();
                    showStatus('loginStatus', `ë“±ë¡ ì‹¤íŒ¨: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ë¡œê·¸ì¸
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    accessToken = result.access_token;
                    showStatus('loginStatus', 'ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                    
                    // ë‹¤ìŒ ì„¹ì…˜ë“¤ í‘œì‹œ
                    document.getElementById('voiceActorSection').classList.remove('hidden');
                    document.getElementById('ttsSection').classList.remove('hidden');
                    document.getElementById('historySection').classList.remove('hidden');
                    
                    // ì„±ìš° ëª©ë¡ ë¡œë“œ
                    loadVoiceActors();
                } else {
                    const error = await response.json();
                    showStatus('loginStatus', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì„±ìš° ëª©ë¡ ë¡œë“œ
        async function loadVoiceActors() {
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors`, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const actors = await response.json();
                    
                    // ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
                    const selects = ['voiceActorSelect', 'selectedVoiceActor'];
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">ì„±ìš°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                        actors.forEach(actor => {
                            const option = document.createElement('option');
                            option.value = actor.id;
                            option.textContent = `${actor.name} (${actor.gender}, ${actor.age_range})`;
                            select.appendChild(option);
                        });
                    });
                    
                    showStatus('voiceActorStatus', `${actors.length}ëª…ì˜ ì„±ìš°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    showStatus('voiceActorStatus', 'ì„±ìš° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('voiceActorStatus', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì„±ìš° ë“±ë¡
        async function createVoiceActor() {
            const name = document.getElementById('actorName').value;
            const gender = document.getElementById('actorGender').value;
            const age_range = document.getElementById('actorAge').value;
            const description = document.getElementById('actorDescription').value;
            
            if (!name) {
                showStatus('voiceActorStatus', 'ì„±ìš°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        name,
                        gender,
                        age_range,
                        language: 'ko',
                        description,
                        characteristics: {
                            tone: 'ì¹œê·¼í•¨',
                            style: 'ë°ìŒ'
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('voiceActorStatus', `ì„±ìš° "${result.name}" ë“±ë¡ ì„±ê³µ!`, 'success');
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('actorName').value = '';
                    document.getElementById('actorDescription').value = '';
                    
                    // ì„±ìš° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadVoiceActors();
                } else {
                    const error = await response.json();
                    showStatus('voiceActorStatus', `ë“±ë¡ ì‹¤íŒ¨: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('voiceActorStatus', `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // TTS ìƒì„±
        async function generateTTS() {
            const text = document.getElementById('ttsText').value;
            const voiceActorId = document.getElementById('selectedVoiceActor').value;
            
            if (!text.trim()) {
                showStatus('ttsStatus', 'í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ìƒì„± ì¤‘...';
            
            try {
                // 1. TTS ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
                const scriptResponse = await fetch(`${API_BASE_URL}/voice-actors/tts-scripts`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        text_content: text,
                        voice_actor_id: voiceActorId || null,
                        voice_settings: {
                            speed: 1.0,
                            temperature: 0.7
                        }
                    })
                });
                
                if (!scriptResponse.ok) {
                    throw new Error('ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨');
                }
                
                const script = await scriptResponse.json();
                
                // 2. TTS ìƒì„± ìš”ì²­
                const generateResponse = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-scripts/${script.id}/generate`,
                    {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            script_id: script.id,
                            generation_params: {
                                quality: 'high'
                            }
                        })
                    }
                );
                
                if (generateResponse.ok) {
                    const generation = await generateResponse.json();
                    currentGenerationId = generation.id;
                    showStatus('ttsStatus', 'TTS ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...', 'info');
                    
                    // ìƒíƒœ í´ë§ ì‹œì‘
                    pollGenerationStatus();
                } else {
                    throw new Error('TTS ìƒì„± ìš”ì²­ ì‹¤íŒ¨');
                }
            } catch (error) {
                showStatus('ttsStatus', `TTS ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'TTS ìƒì„±í•˜ê¸°';
            }
        }
        
        // ìƒì„± ìƒíƒœ í´ë§
        async function pollGenerationStatus() {
            if (!currentGenerationId) return;
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}`,
                    { headers: getHeaders() }
                );
                
                if (response.ok) {
                    const generation = await response.json();
                    const status = generation.status;
                    
                    if (status === 'completed') {
                        showStatus('ttsStatus', 'TTS ìƒì„± ì™„ë£Œ!', 'success');
                        
                        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ í‘œì‹œ
                        const audioResult = document.getElementById('audioResult');
                        const audioPlayer = document.getElementById('audioPlayer');
                        
                        audioPlayer.src = `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}/audio`;
                        audioResult.classList.remove('hidden');
                        
                        // íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨
                        loadGenerations();
                        
                    } else if (status === 'failed') {
                        const errorMsg = generation.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                        showStatus('ttsStatus', `TTS ìƒì„± ì‹¤íŒ¨: ${errorMsg}`, 'error');
                        
                    } else if (status === 'processing' || status === 'pending') {
                        showStatus('ttsStatus', `TTS ìƒì„± ì¤‘... (ìƒíƒœ: ${status})`, 'info');
                        // 3ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸
                        setTimeout(pollGenerationStatus, 3000);
                    }
                } else {
                    showStatus('ttsStatus', 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('ttsStatus', `ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
        async function downloadAudio() {
            if (!currentGenerationId) return;
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}/audio`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tts_${currentGenerationId.substring(0, 8)}.wav`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    showStatus('ttsStatus', 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('ttsStatus', `ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // TTS ìƒì„± íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadGenerations() {
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors/tts-generations`, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const generations = await response.json();
                    const listElement = document.getElementById('generationList');
                    
                    if (generations.length === 0) {
                        listElement.innerHTML = '<p>ìƒì„±ëœ TTSê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    listElement.innerHTML = generations.map(gen => {
                        const statusClass = gen.status === 'completed' ? 'success' : 
                                          gen.status === 'failed' ? 'error' : 'info';
                        
                        return `
                            <div class="generation-item">
                                <div class="status ${statusClass}">ìƒíƒœ: ${gen.status}</div>
                                <p><strong>í…ìŠ¤íŠ¸:</strong> ${gen.script?.text_content?.substring(0, 100) || 'N/A'}...</p>
                                <p><strong>ì„±ìš°:</strong> ${gen.voice_actor_name || 'ê¸°ë³¸ ìŒì„±'}</p>
                                <p><strong>ìƒì„±ì¼:</strong> ${new Date(gen.created_at).toLocaleString()}</p>
                                ${gen.quality_score ? `<p><strong>í’ˆì§ˆ:</strong> ${gen.quality_score.toFixed(1)}ì </p>` : ''}
                                ${gen.status === 'completed' ? `
                                    <audio controls style="width: 100%; margin-top: 10px;">
                                        <source src="${API_BASE_URL}/voice-actors/tts-generations/${gen.id}/audio" type="audio/wav">
                                    </audio>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // API ì„œë²„ ìƒíƒœ í™•ì¸
            fetch(`${API_BASE_URL}/health`)
                .then(response => {
                    if (response.ok) {
                        showStatus('loginStatus', 'API ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
                    } else {
                        showStatus('loginStatus', 'API ì„œë²„ ì—°ê²° ì˜¤ë¥˜', 'error');
                    }
                })
                .catch(error => {
                    showStatus('loginStatus', `API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (${API_BASE_URL})`, 'error');
                });
        });
    </script>
</body>
</html>
