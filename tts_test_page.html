<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS 기능 테스트 페이지</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .audio-controls {
            margin-top: 15px;
        }
        audio {
            width: 100%;
            margin-top: 10px;
        }
        .generation-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }
        .generation-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎙️ TTS 기능 테스트</h1>
        
        <!-- 로그인 섹션 -->
        <div class="section" id="loginSection">
            <h3>1. 로그인</h3>
            <label for="username">사용자명:</label>
            <input type="text" id="username" value="test_user" placeholder="사용자명을 입력하세요">
            
            <label for="password">비밀번호:</label>
            <input type="password" id="password" value="test_password123" placeholder="비밀번호를 입력하세요">
            
            <button onclick="login()">로그인</button>
            <button onclick="register()">사용자 등록</button>
            
            <div id="loginStatus"></div>
        </div>
        
        <!-- 성우 관리 섹션 -->
        <div class="section hidden" id="voiceActorSection">
            <h3>2. 성우 관리</h3>
            
            <div style="margin-bottom: 20px;">
                <h4>기존 성우 목록</h4>
                <button onclick="loadVoiceActors()">성우 목록 새로고침</button>
                <select id="voiceActorSelect">
                    <option value="">성우를 선택하세요</option>
                </select>
            </div>
            
            <div>
                <h4>새 성우 등록</h4>
                <label for="actorName">성우명:</label>
                <input type="text" id="actorName" placeholder="성우 이름">
                
                <label for="actorGender">성별:</label>
                <select id="actorGender">
                    <option value="female">여성</option>
                    <option value="male">남성</option>
                    <option value="neutral">중성</option>
                </select>
                
                <label for="actorAge">연령대:</label>
                <select id="actorAge">
                    <option value="20s">20대</option>
                    <option value="30s">30대</option>
                    <option value="40s">40대</option>
                    <option value="50s">50대</option>
                </select>
                
                <label for="actorDescription">설명:</label>
                <textarea id="actorDescription" placeholder="성우에 대한 설명"></textarea>
                
                <button onclick="createVoiceActor()">성우 등록</button>
            </div>
            
            <div id="voiceActorStatus"></div>
        </div>
        
        <!-- TTS 생성 섹션 -->
        <div class="section hidden" id="ttsSection">
            <h3>3. TTS 생성</h3>
            
            <label for="ttsText">생성할 텍스트:</label>
            <textarea id="ttsText" placeholder="음성으로 변환할 텍스트를 입력하세요...">안녕하세요. OO손해보험입니다. 고객님의 소중한 재산을 보호하기 위해 최선을 다하겠습니다. 무엇을 도와드릴까요?</textarea>
            
            <label for="selectedVoiceActor">성우 선택:</label>
            <select id="selectedVoiceActor">
                <option value="">성우를 선택하세요</option>
            </select>
            
            <button onclick="generateTTS()" id="generateBtn">TTS 생성하기</button>
            
            <div id="ttsStatus"></div>
            
            <div id="audioResult" class="hidden">
                <h4>생성된 음성</h4>
                <audio controls id="audioPlayer"></audio>
                <div class="audio-controls">
                    <button onclick="downloadAudio()">다운로드</button>
                </div>
            </div>
        </div>
        
        <!-- TTS 히스토리 섹션 -->
        <div class="section hidden" id="historySection">
            <h3>4. TTS 생성 히스토리</h3>
            <button onclick="loadGenerations()">히스토리 새로고침</button>
            <div id="generationList" class="generation-list"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let accessToken = null;
        let currentGenerationId = null;
        
        // 상태 메시지 표시
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // API 호출 헤더
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            return headers;
        }
        
        // 사용자 등록
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', '사용자명과 비밀번호를 입력해주세요.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        username,
                        password,
                        email: `${username}@example.com`,
                        full_name: username
                    })
                });
                
                if (response.ok) {
                    showStatus('loginStatus', '사용자 등록 성공! 이제 로그인하세요.', 'success');
                } else {
                    const error = await response.json();
                    showStatus('loginStatus', `등록 실패: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', `네트워크 오류: ${error.message}`, 'error');
            }
        }
        
        // 로그인
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('loginStatus', '사용자명과 비밀번호를 입력해주세요.', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    accessToken = result.access_token;
                    showStatus('loginStatus', '로그인 성공!', 'success');
                    
                    // 다음 섹션들 표시
                    document.getElementById('voiceActorSection').classList.remove('hidden');
                    document.getElementById('ttsSection').classList.remove('hidden');
                    document.getElementById('historySection').classList.remove('hidden');
                    
                    // 성우 목록 로드
                    loadVoiceActors();
                } else {
                    const error = await response.json();
                    showStatus('loginStatus', `로그인 실패: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('loginStatus', `네트워크 오류: ${error.message}`, 'error');
            }
        }
        
        // 성우 목록 로드
        async function loadVoiceActors() {
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors`, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const actors = await response.json();
                    
                    // 선택 옵션 업데이트
                    const selects = ['voiceActorSelect', 'selectedVoiceActor'];
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">성우를 선택하세요</option>';
                        actors.forEach(actor => {
                            const option = document.createElement('option');
                            option.value = actor.id;
                            option.textContent = `${actor.name} (${actor.gender}, ${actor.age_range})`;
                            select.appendChild(option);
                        });
                    });
                    
                    showStatus('voiceActorStatus', `${actors.length}명의 성우를 로드했습니다.`, 'success');
                } else {
                    showStatus('voiceActorStatus', '성우 목록 로드 실패', 'error');
                }
            } catch (error) {
                showStatus('voiceActorStatus', `네트워크 오류: ${error.message}`, 'error');
            }
        }
        
        // 성우 등록
        async function createVoiceActor() {
            const name = document.getElementById('actorName').value;
            const gender = document.getElementById('actorGender').value;
            const age_range = document.getElementById('actorAge').value;
            const description = document.getElementById('actorDescription').value;
            
            if (!name) {
                showStatus('voiceActorStatus', '성우명을 입력해주세요.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        name,
                        gender,
                        age_range,
                        language: 'ko',
                        description,
                        characteristics: {
                            tone: '친근함',
                            style: '밝음'
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('voiceActorStatus', `성우 "${result.name}" 등록 성공!`, 'success');
                    
                    // 폼 초기화
                    document.getElementById('actorName').value = '';
                    document.getElementById('actorDescription').value = '';
                    
                    // 성우 목록 새로고침
                    loadVoiceActors();
                } else {
                    const error = await response.json();
                    showStatus('voiceActorStatus', `등록 실패: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('voiceActorStatus', `네트워크 오류: ${error.message}`, 'error');
            }
        }
        
        // TTS 생성
        async function generateTTS() {
            const text = document.getElementById('ttsText').value;
            const voiceActorId = document.getElementById('selectedVoiceActor').value;
            
            if (!text.trim()) {
                showStatus('ttsStatus', '텍스트를 입력해주세요.', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '생성 중...';
            
            try {
                // 1. TTS 스크립트 생성
                const scriptResponse = await fetch(`${API_BASE_URL}/voice-actors/tts-scripts`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        text_content: text,
                        voice_actor_id: voiceActorId || null,
                        voice_settings: {
                            speed: 1.0,
                            temperature: 0.7
                        }
                    })
                });
                
                if (!scriptResponse.ok) {
                    throw new Error('스크립트 생성 실패');
                }
                
                const script = await scriptResponse.json();
                
                // 2. TTS 생성 요청
                const generateResponse = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-scripts/${script.id}/generate`,
                    {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            script_id: script.id,
                            generation_params: {
                                quality: 'high'
                            }
                        })
                    }
                );
                
                if (generateResponse.ok) {
                    const generation = await generateResponse.json();
                    currentGenerationId = generation.id;
                    showStatus('ttsStatus', 'TTS 생성이 시작되었습니다. 상태를 확인하는 중...', 'info');
                    
                    // 상태 폴링 시작
                    pollGenerationStatus();
                } else {
                    throw new Error('TTS 생성 요청 실패');
                }
            } catch (error) {
                showStatus('ttsStatus', `TTS 생성 실패: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'TTS 생성하기';
            }
        }
        
        // 생성 상태 폴링
        async function pollGenerationStatus() {
            if (!currentGenerationId) return;
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}`,
                    { headers: getHeaders() }
                );
                
                if (response.ok) {
                    const generation = await response.json();
                    const status = generation.status;
                    
                    if (status === 'completed') {
                        showStatus('ttsStatus', 'TTS 생성 완료!', 'success');
                        
                        // 오디오 플레이어 표시
                        const audioResult = document.getElementById('audioResult');
                        const audioPlayer = document.getElementById('audioPlayer');
                        
                        audioPlayer.src = `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}/audio`;
                        audioResult.classList.remove('hidden');
                        
                        // 히스토리 새로고침
                        loadGenerations();
                        
                    } else if (status === 'failed') {
                        const errorMsg = generation.error_message || '알 수 없는 오류';
                        showStatus('ttsStatus', `TTS 생성 실패: ${errorMsg}`, 'error');
                        
                    } else if (status === 'processing' || status === 'pending') {
                        showStatus('ttsStatus', `TTS 생성 중... (상태: ${status})`, 'info');
                        // 3초 후 다시 확인
                        setTimeout(pollGenerationStatus, 3000);
                    }
                } else {
                    showStatus('ttsStatus', '상태 확인 실패', 'error');
                }
            } catch (error) {
                showStatus('ttsStatus', `상태 확인 오류: ${error.message}`, 'error');
            }
        }
        
        // 오디오 다운로드
        async function downloadAudio() {
            if (!currentGenerationId) return;
            
            try {
                const response = await fetch(
                    `${API_BASE_URL}/voice-actors/tts-generations/${currentGenerationId}/audio`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tts_${currentGenerationId.substring(0, 8)}.wav`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    showStatus('ttsStatus', '다운로드 실패', 'error');
                }
            } catch (error) {
                showStatus('ttsStatus', `다운로드 오류: ${error.message}`, 'error');
            }
        }
        
        // TTS 생성 히스토리 로드
        async function loadGenerations() {
            try {
                const response = await fetch(`${API_BASE_URL}/voice-actors/tts-generations`, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const generations = await response.json();
                    const listElement = document.getElementById('generationList');
                    
                    if (generations.length === 0) {
                        listElement.innerHTML = '<p>생성된 TTS가 없습니다.</p>';
                        return;
                    }
                    
                    listElement.innerHTML = generations.map(gen => {
                        const statusClass = gen.status === 'completed' ? 'success' : 
                                          gen.status === 'failed' ? 'error' : 'info';
                        
                        return `
                            <div class="generation-item">
                                <div class="status ${statusClass}">상태: ${gen.status}</div>
                                <p><strong>텍스트:</strong> ${gen.script?.text_content?.substring(0, 100) || 'N/A'}...</p>
                                <p><strong>성우:</strong> ${gen.voice_actor_name || '기본 음성'}</p>
                                <p><strong>생성일:</strong> ${new Date(gen.created_at).toLocaleString()}</p>
                                ${gen.quality_score ? `<p><strong>품질:</strong> ${gen.quality_score.toFixed(1)}점</p>` : ''}
                                ${gen.status === 'completed' ? `
                                    <audio controls style="width: 100%; margin-top: 10px;">
                                        <source src="${API_BASE_URL}/voice-actors/tts-generations/${gen.id}/audio" type="audio/wav">
                                    </audio>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('히스토리 로드 오류:', error);
            }
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // API 서버 상태 확인
            fetch(`${API_BASE_URL}/health`)
                .then(response => {
                    if (response.ok) {
                        showStatus('loginStatus', 'API 서버에 연결되었습니다. 로그인해주세요.', 'success');
                    } else {
                        showStatus('loginStatus', 'API 서버 연결 오류', 'error');
                    }
                })
                .catch(error => {
                    showStatus('loginStatus', `API 서버에 연결할 수 없습니다. 서버가 실행 중인지 확인해주세요. (${API_BASE_URL})`, 'error');
                });
        });
    </script>
</body>
</html>
