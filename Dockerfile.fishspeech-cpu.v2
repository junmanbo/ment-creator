# Fish Speech TTS API ì„œë²„ë¥¼ ìœ„í•œ CPU ë²„ì „ Dockerfile (ê°œì„ ëœ ë²„ì „)
FROM python:3.11-slim

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì˜¤ë””ì˜¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
RUN apt-get update && apt-get install -y \
    git \
    wget \
    build-essential \
    libsndfile1 \
    libsndfile1-dev \
    ffmpeg \
    portaudio19-dev \
    libasound2-dev \
    libportaudio2 \
    libpulse-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Fish Speech ì €ì¥ì†Œ í´ë¡ 
RUN git clone https://github.com/fishaudio/fish-speech.git /app/fish-speech

# Fish Speech ë””ë ‰í† ë¦¬ë¡œ ì´ë™
WORKDIR /app/fish-speech

# Python ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --upgrade pip setuptools wheel

# PyTorch CPU ë²„ì „ ì„¤ì¹˜
RUN pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cpu

# í•„ìˆ˜ ì˜ì¡´ì„± ë¨¼ì € ì„¤ì¹˜
RUN pip install pyrootutils>=1.0.4 fastapi uvicorn httpx librosa soundfile

# Fish Speech í•µì‹¬ ì˜ì¡´ì„± ìˆ˜ë™ ì„¤ì¹˜ (pyaudio ì œì™¸)
RUN pip install \
    accelerate \
    datasets \
    einops \
    fire \
    hydra-core \
    lightning \
    omegaconf \
    rich \
    tensorboard \
    transformers \
    gradio \
    wandb \
    --no-deps || echo "ì¼ë¶€ íŒ¨í‚¤ì§€ ê±´ë„ˆëœ€"

# pyaudio ìˆ˜ë™ ì„¤ì¹˜ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
RUN pip install pyaudio || echo "pyaudio ì„¤ì¹˜ ì‹¤íŒ¨ - TTS ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ"

# Fish Speech ì†ŒìŠ¤ ì„¤ì¹˜ (ì—ëŸ¬ ë¬´ì‹œ)
RUN pip install -e . || echo "Fish Speech ì†ŒìŠ¤ ì„¤ì¹˜ ì™„ë£Œ"

# S1 ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
RUN mkdir -p checkpoints
RUN wget -O checkpoints/fish-speech-1.4-s1.pth \
    https://huggingface.co/fishaudio/fish-speech-1.4/resolve/main/fish-speech-1.4-s1.pth || \
    echo "ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ - ëŸ°íƒ€ì„ì— ìë™ ë‹¤ìš´ë¡œë“œë¨"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8765

# í™˜ê²½ë³€ìˆ˜ ì„¤ì • (CPU ëª¨ë“œ)
ENV PYTHONPATH=/app/fish-speech
ENV CUDA_VISIBLE_DEVICES=""

# Fish Speech API ì„œë²„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (CPU ëª¨ë“œ)
RUN echo '#!/bin/bash\n\
cd /app/fish-speech\n\
echo "ğŸŸ Fish Speech API ì„œë²„ ì‹œì‘ ì¤‘ (CPU ëª¨ë“œ)..."\n\
python -m fish_speech.webui.api \\\n\
    --listen 0.0.0.0:8765 \\\n\
    --llama-checkpoint-path checkpoints/fish-speech-1.4-s1.pth \\\n\
    --decoder-checkpoint-path checkpoints \\\n\
    --device cpu \\\n\
    --max-length 4096 \\\n\
    || echo "âŒ API ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"\n\
' > /app/start_server.sh

RUN chmod +x /app/start_server.sh

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8765/health || curl -f http://localhost:8765/ || exit 1

# ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹
CMD ["/app/start_server.sh"]
